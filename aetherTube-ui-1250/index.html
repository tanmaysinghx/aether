<!DOCTYPE html>
<html>
<head>
    <title>Aether HLS Verification</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        video { width: 100%; border: 1px solid #ccc; margin-top: 20px; }
        input { padding: 8px; width: 300px; }
        button { padding: 8px 16px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Aether Video Verification</h1>
        <div>
            <label>Job ID:</label>
            <input type="text" id="jobId" placeholder="Enter Job UUID">
            <button onclick="loadVideo()">Play</button>
        </div>
        
        <div style="margin-top: 10px;">
            <label>Quality:</label>
            <select id="qualitySelect" onchange="changeQuality()">
                <option value="-1">Auto</option>
            </select>
        </div>

        <video id="video" controls></video>
        <div id="status"></div>
    </div>

    <script>
        var video = document.getElementById('video');
        var statusDiv = document.getElementById('status');
        var qualitySelect = document.getElementById('qualitySelect');
        var hls = null;
        var currentJobId = null;
        var progressInterval = null;

        function loadVideo() {
            var jobId = document.getElementById('jobId').value.trim();
            if (!jobId) return;
            
            currentJobId = jobId;

            var streamUrl = 'http://localhost:1205/api/v1/stream/' + jobId + '/master.m3u8';
            statusDiv.innerText = 'Loading: ' + streamUrl;

            cleanup();

            if (Hls.isSupported()) {
                hls = new Hls({
                    debug: false,
                });
                hls.loadSource(streamUrl);
                hls.attachMedia(video);
                
                hls.on(Hls.Events.MANIFEST_PARSED, function(event, data) {
                    // Populate Quality Levels
                    qualitySelect.innerHTML = '<option value="-1">Auto</option>';
                    data.levels.forEach(function(level, index) {
                        var opt = document.createElement('option');
                        opt.value = index;
                        opt.text = level.height + 'p (' + (level.bitrate / 1000).toFixed(0) + 'kbps)';
                        qualitySelect.appendChild(opt);
                    });

                    // Fetch Last Progress
                    fetchProgress(jobId);
                });

                hls.on(Hls.Events.ERROR, function(event, data) {
                    console.error(data);
                    statusDiv.innerText += ' -> Error: ' + data.details;
                });
            }
        }

        function changeQuality() {
            if (hls) {
                hls.currentLevel = parseInt(qualitySelect.value);
            }
        }

        function fetchProgress(jobId) {
            // Hardcoded User ID for demo
            fetch('http://localhost:1205/api/v1/play/progress/' + jobId, {
                headers: { 'X-User-Id': '00000000-0000-0000-0000-000000000000' }
            })
            .then(res => res.json())
            .then(data => {
                if (data.success && data.data > 0) {
                    console.log('Resuming from:', data.data);
                    video.currentTime = data.data;
                    statusDiv.innerText += ' -> Resumed at ' + data.data + 's';
                }
                video.play();
                startProgressHeaderbeat();
            });
        }

        function startProgressHeaderbeat() {
            progressInterval = setInterval(() => {
                if (!video.paused && currentJobId) {
                    fetch('http://localhost:1205/api/v1/play/progress', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-User-Id': '00000000-0000-0000-0000-000000000000'
                        },
                        body: JSON.stringify({
                            videoId: currentJobId,
                            progress: video.currentTime
                        })
                    });
                }
            }, 5000);
        }

        function cleanup() {
            if (hls) hls.destroy();
            if (progressInterval) clearInterval(progressInterval);
        }
    </script>
</body>
</html>